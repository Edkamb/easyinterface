{% -*- mode: LaTeX; TeX-PDF-mode: t; TeX-master: "manual"; -*-
}
\chapter{\ei Server}
\label{ch:server}

This chapter describes the server side of the \ei framework, that we
refer to as the \ei server (or simply the server).
%
As explained in Section~\ref{ch:overview:arch:server}, the goal of
this server is to provide a uniform way to access local applications
and examples (i.e., those installed on the same machine where the
server runs).


The \ei server achieves the above goal by:
%
(1) providing a way to describe, using XML based configuration files,
how to execute a local application and which parameters it takes, as
well as define sets of related examples; and
%
(2) providing a JSON based protocol that can be used to request
information on those applications and examples, execute applications,
etc.
%
Section~\ref{ch:server:config} describes the syntax of the server
configuration file, which covers point~(1) above; and
Section~\ref{ch:server:protocol} describes the protocol that can be
used to communicate with the server.
%
This chapter does not cover issues related to installation, for such
documentation see
\texttt{\href{http://github.com/abstools/easyinterface}{INSTALL.md}}.


\section{Configuring the \ei Server}
\label{ch:server:config}

This section describes how to configure the \ei server.
%
Section~\ref{ch:server:config:file} explains where the configuration
file show be placed, and Section~\ref{ch:server:config:xml} describes
the (valid) content of this file.
%
Before proceeding to the next sections, it highly recommended to read
Chapter~\ref{ch:quickguide} to get a general idea on how the
configuration file looks like, etc.


\subsection{Name and Path of the Configuration File}
\label{ch:server:config:file}

By default the server looks for the configuration file
\texttt{server/config/eiserver.cfg}, and if no such file exists it
uses \texttt{server/config/eiserver.default.cfg}.
%
The default installation comes with a predefined
\texttt{sever/config/eiserver.default.cfg} that includes some demo
applications and corresponding examples. It is very recommended not
make substantial changes to \texttt{eiserver.default.cfg}, and instead
create your own \texttt{eiserver.cfg}. This way you can always have a
correct configuration file at hand from which you can copy, etc.

\subsection{The Syntax of the Configuration File}
\label{ch:server:config:xml}

The content of the configuration file should adhere to the
\xmlstructrefwb{eiserver} XML structure that is described below.
%
Inside this tag you can define applications, examples, etc. The best
way to understand how to do is follow the links in the defintion of
\xmlstructref{eiserver}.

\subsubsection*{General comment about XML structures} 

For the purpose of better organization of the configuration files, any
XML structure

\medskip
\begin{lstlisting}
<tagname ...>
  ....
</tagname>
\end{lstlisting}

\medskip
\noindent
can be also wtitten as

\medskip
\begin{lstlisting}
<tagname src=$\xmlstructref{cfgfilename}$ />
\end{lstlisting}

\medskip
\noindent
where the file \xmlstructref{cfgfilename} includes the actual XML
structure (of the first form). However, if the XML structure has an
attribute \lst{id} then it must appear as well in the second form.

\subsubsection*{The main XML tag of the configuration file}

%% EISERVER
\bigskip
\xmlstruct
{eiserver}
{%
This XML tag is the root of the configurations file.
%
The \xmlstructref{settings} section is used for setting some global
parameters; the \xmlstructref{apps} section defines which applications
are available on the server; and \xmlstructref{examples} defines which
sets of examples are available on the server.
%
}
{}%r%


\subsubsection*{General settings}

%% SETTINGS
\bigskip
\xmlstruct
{settings}
{%
%
  This tag is does not include anything yet. It is reserved for future
  use, where we plan to put general settings that are related to the
  server and not to specific application or examples set.
%
}
{}%r%

\subsubsection*{Examples settings}

%% EXAMPLES
\bigskip
\xmlstruct
{examples}
{%
%
  This tag is used to declare sets of examples sets that are available
  in the server, where each such set is defined by one
  \xmlstructref{exset}.
%
}
{}%r%

%% EXSET
\bigskip
\xmlstruct
{exset}
{%
%
  This tag declare a set of examples, which are defined by collection
  of \xmlstructref{exelement} (a file, a directory, or a link to a
  github repository).
%
  The attribute \xmlstructattr{id} is a unique identifier that is used
  to refer to this set when communicating with the server.
%
}
{}%r%

%% EXAMPLE element
\bigskip
\xmlstruct
{exelement}
{%
%
  An example element, which can be a file \xmlstructref{file}, a
  folder \xmlstructref{folder}, or a link to a github repository
  \xmlstructref{github}.
%
}
{}%r%


%% File
\bigskip
\xmlstruct
{file}
{%
%
  This tags declares a file, where the \xmlstructattr{name} attribute
  is its name and \xmlstructattr{url} is a link to its content. Note
  that \xmlstructattr{name} is not necessarily the same as the one in
  \xmlstructattr{url}.
%
}
{}%r%

%% Folder
\bigskip
\xmlstruct
{folder}
{%
%
  This tags declares a folder with \xmlstructattr{name} as its
  name. The content of this is a list of \xmlstructref{exelement}
  tags, which in turn declare the inner files, folders, etc.
%
}
{}%r%


%% GitHub
\bigskip
\xmlstruct
{github}
{%
%
  Declares a reference to the public github repository
  \xmlstructattr{repo} which is owned by the user
  \xmlstructattr{owner}. Optionally one can also refer to a specific
  \xmlstructattr{branch} which \texttt{master} by default, and to a
  specific \xmlstructattr{path} (a directory or a single file) which
  is a the root directory by default.
%
}
{}%r%

\subsubsection*{Applications settings}

%% APPS
\bigskip
\xmlstruct
{apps}
{%
%
  Thhis tag declares a list of applications (to be added to the
  server). Each such application is defined by one \xmlstructref{app}
  environment.  
%
} 
{}%r%

%% APP
\bigskip
\xmlstruct
{app}
{%
%
  This tag defines an application, where the meaning different parts
  is as follows:
%
  \begin{itemize}

  \item \xmlstructattr{id} is a unique identifier used to refer to
    this application when communicating with the server.

  \item \xmlstructattr{visible} indicates if this application should
    be listed when the list of available applications is requested ---
    by default it is \texttt{true}. 
    %
    Note that even if an application is not visible, it can be used
    like any other application by those who know it
    \xmlstructattr{id}.

  \item \xmlstructref{appinfo} provides some general information about
    the application, e.g., title, logo, etc.

  \item \xmlstructref{apphelp} provides enough information on how the
    application can be used, etc. It is mainly used in the help
    sections of the different clients.

  \item \xmlstructref{execinfo} defines how the application can be
    executed (e.g., from a command-line).

  \item \xmlstructref{parameters} defines the set parameters accepted
    by the application.

  \end{itemize}
%
}
{}%r%


%% APPINFO
\bigskip
\xmlstruct
{appinfo}
{%
%
  This tag provides general information for an application:
%
  \begin{itemize}
  \item \xmlstructref{acronym} is an acronym for the application,
    e.g., COSTA;
  \item \xmlstructref{title} is the full name of the application;
  \item \xmlstructref{logo} is an image corresponding to the log of
    the application; and
  \item \xmlstructref{desc} is a description of the tool.
  \end{itemize}
%
}
{}%r%


%% ACRONYM
\bigskip
\xmlstruct
{acronym}
{%
%
  Plain text to be used as an acronym, e.g., COSTA.
%
}
{}%r%


%% TITLE
\bigskip
\xmlstruct
{title}
{%
%
  Plain text deciding a title, e.g., for an application. It is
  typically more informative than an acronym (see
  $\xmlstructref{acronym}$.
%
}
{}%r%


%% LOGO
\bigskip
\xmlstruct
{logo}
{%
%
  A link to an image --- in some standard format such
  \xmlstructvalue{png}, \xmlstructvalue{jpg} or \xmlstructvalue{gif}
  --- to be used by clients as a logo (for an \app). 
%
}
{}%r%


%% DESC
\bigskip
\xmlstruct
{desc}
{%
%
  This is a description of some entities, e.g., of an application, a
  parameter, a parameter option, etc. It consists of two parts, the
  first one is a short description, and the second is a detailed
  description. In both cases it should be plain text. Clients will
  select one of them depending on the intended use.
%
}
{}%


%% APPHELP
\bigskip
\xmlstruct
{apphelp}
{%
%
  A (formatted) text that provides enough information on how an
  application can be used, etc. It can be provided in several formats,
  e.g., html or plain text, by using several \xmlstructref{content}
  tags. Clients are supposed to pick the appropriate format if more
  than one is available. It is recommended to always include a content
  in plain text since it can be view in any client.
%
}
{}%r%


%% CONTENT
\bigskip
\xmlstruct
{content}
{%
%
  A text given in a specific \xmlstructattr{format}, e.g.,
  \xmlstructvalue{"text"}, \xmlstructvalue{"html"}, etc. If the
  attribute \xmlstructattr{format} is not provided, then it is assumed
  to be \xmlstructvalue{"text"} format (plain text).
%
}
{}%r%

%% EXECINFO
\bigskip
\xmlstruct{execinfo}
{%
%
  Provides information on how to execute an application. Currently it
  includes only a command-line template \xmlstructref{cmdlineapp}.
%
}
{}%r%

%% CMDLINEAPP
\noindent
\xmlstruct{cmdlineapp}
{%
%
  Describes how to run an application, where
  \xmlstructdef{command\_template} is a template describing a
  command-line. It is best explained by an example. Consider the
  following template example

  \bigskip
  ~~~
  \fbox{\small\texttt{/path-to/app \xmlstructtemplate{_ei_files} -m \xmlstructtemplate{_ei_outline}  \xmlstructtemplate{_ei_parameters}}}
  
  \bigskip
  \noindent
  In this template, anything that starts with \xmlstructtemplate{_ei}
  is a template parameter that will be replaced by some corresponding
  information, and \texttt{/path-to/app} is the application
  executable.
  % 
  When the server receives a request for executing the corresponding
  application, the request includes several data that should passed to
  the application. For example, the following are typical data that
  should be passed to an application:
  %
  \begin{enumerate}
  \item files to be processed (e.g., program to be analyzed);
  \item entities selected from the program outline (e.g., methods); and
  \item values for the different parameters.
  \end{enumerate}
  %
  The server passes this data to the application by replacing the
  template parameters with corresponding data as follows:
  % 
  \begin{enumerate}
  \item the files are stored locally (e.g., in \texttt{/tmp}), and
    \xmlstructtemplate{_ei_files} is replaced by a list file names
    (each with an absolute path, separated by a space);
  \item \xmlstructtemplate{_ei_outline} is replaced by a list of
    selected entities (e.g., method names); and
  \item \xmlstructtemplate{_ei_parameters} is replaced by the list of
    parameters generated from those provided in the request.
  \end{enumerate}
  % 
  This result in, for example, the following instance of the template:

  \bigskip
  \hspace{0.7cm}
  \fbox{\texttt{/path-to/app \xmlstructtemplate{a.c b.c} -m \xmlstructtemplate{a.main} \xmlstructtemplate{-v 1 -d 3 -a}}}

  \bigskip 
  \noindent
  which is then executed and its output is redirected to the
  client. The server does some security checks to guarantee that the
  command-line is not harmful. % TODO refer to the security section when available

  \bigskip 
  \noindent
  The following is a list of template parameters that can be used:

%%
  \begin{itemize}
  \item \xmlstructtemplate{_ei_files} is replaced by a list of file
    names (separated by space) in the local file system;

  \item \xmlstructtemplate{_ei_root} is replaced by the local
    temporary directory name, where all files have been saved. This
    file is of the form \texttt{/path-to-tmp/\_ei\_files} where
    \texttt{/path-to-tmp} depends on the operating system (e.g.,
    \texttt{/tmp} in Linux);
%%
  \item \xmlstructtemplate{_ei_outline} is replaced by a list of
    selected entities (separated by space);
%%
  \item \xmlstructtemplate{_ei_parameters} is replaced by a
    corresponding list of parameters (see \xmlstructref{parameters});
%%
  \item \xmlstructtemplate{_ei_sessionid} is replaced by a session
    identifier, this makes it possible to track the information of a
    user along several request;
%%
  \item \xmlstructtemplate{_ei_clientid} is replaced by the client
    identifier, i.e., \texttt{webclient}, \texttt{eclipse}, etc.,
    which makes it possible to provide output depending on the
    client. See Chapter~\ref{ch:clients} for a list of clients and
    their corresponding identifiers.
  \end{itemize}
%
}
{}%r%

\subsubsection{Application parameters}

%% PARAMETERS
\bigskip 
\xmlstruct
{parameters} 
{%
%
  Defines a list of parameters that are accepted by a corresponding
  application. Each parameter is define by one \xmlstructref{param}
  environment. 
  %
  The \xmlstructattr{prefix} attribute is used to specify a string
  that will be attached to each parameter name when passed to the
  application.
  % 
  For example, if \xmlstructattr{prefix}=\xmlstructvalue{"{-}{-}"} and
  there is a parameter called 'level' with value X, then '{-}{-}level
  X' will be passed to the application.  The default value of
  \xmlstructattr{prefix} is \xmlstructvalue{"-"}. It can also be set
  to an empty string if there is no need for a prefix.
  %
  The \xmlstructattr{check} attribute is used to indicate if the
  server should verify that the values of the parameters are valid
  (w.r.t. the specified values). The default value of
  \xmlstructattr{check} is \xmlstructvalue{"true"}.
  %
  The attributes \xmlstructattr{prefix} and \xmlstructattr{check} are
  inherited by each parameter \xmlstructref{param}, which in turn can
  override then as well.
%
}
{}%

%% PARAM
\bigskip
\xmlstruct{param}
{
%
  Defines a parameter accepted by a corresponding application. There
  are several types of paramaters supported:
\begin{itemize}
\item \xmlstructref{selectone} defines a parameter that takes one
  value from a predefined set;
\item \xmlstructref{selectmany} defines a parameter that takes several
  values from a predefined set;
\item \xmlstructref{flag} defines a parameter that either appear or
  not in the commeand-line; and
\item \xmlstructref{textfield} defines a parameter that take a
  free-text value.
\end{itemize}
%
}
{}%r%

%% SELECTONE
\bigskip
\xmlstruct
{selectone}
{%
%
  Defines a parameter that takes a \emph{single} value out of a given
  list:

  \begin{itemize}
  \item \xmlstructattr{name} is the name of the parameter, it must be
    unique among all parameters of an app;

  \item \xmlstructattr{prefix} and \xmlstructattr{check} can be used
    to override the corresponding attributes of
    \xmlstructref{parameters};

  \item \xmlstructref{desc} provide a description of this parameter;

  \item \xmlstructref{option}+ is a list of possible values for
    this parameter;

  \item \xmlstructref{defaultvalue} specifies the default value. If
    not specified then the first \xmlstructref{option} is considered
    as the default one;

  \item \xmlstructattr{widgetid} specifies the preferred layout when
    used in a client with a graphical interface (e.g., combo-box,
    radio button, etc.). This is client depends, see
    Chapter~\ref{ch:clients} for more information.

  \end{itemize}
%
}
{}%r%

%% SELECTMANY
\bigskip
\xmlstruct{selectmany}
{%
%
  Defines a parameter that takes \emph{several} values out of a given
  list. The meaning of the attributes and inner environments is as in
  \xmlstructref{selectone}, except that in this case we can specify
  several  \xmlstructref{defaultvalue}.
%
}
{}%r%

%% FLAG
\bigskip
\xmlstruct{flag}
{%
%
  Defines a parameter that can take \texttt{true} or \texttt{false}
  values. The meaning of the attributes and inner environments is as
  in \xmlstructref{selectone}. In addition, the attribute
  \xmlstructattr{explicit} is used to specify how this parameter
  should be passed to the application. For example, assume the
  parameter name is \texttt{f}, then:
  % 
  \begin{itemize}
  %  
  \item when \xmlstructattr{explicit} is \xmlstructvalue{true} the
    parameter is explicitly passed to the application, i.e., using
    ``\texttt{-f true}'' or ``\texttt{-f false}''; and
  %
  \item when \xmlstructattr{explicit} is \xmlstructvalue{false}
    parameter is passed as ``\texttt{-f}'' if its value is
    \texttt{true} and not passed at all if its value is
    \texttt{false}.
  % 
  \end{itemize}
%
  The default value of \xmlstructattr{explicit} is
  \xmlstructvalue{false}.
%
}
{}%r%

%% TEXTFIELD
\bigskip
\xmlstruct{textfield}
{%
%
  Defines a parameter that can take free-text value. The meaning of
  the attributes and inner environments is as in
  \xmlstructref{selectone}. The \lst{initialtext} tag includes a text
  to be shown in the corresponding text-area by default.  The meaning
  of extra attributes is as follows:
%
\begin{itemize}
%
\item \xmlstructattr{multiline} is used to specify if the free-text
  should be single-line or multi-lines. By default its values is
  \xmlstructvalue{false}, i.e., single-line.
%
\item \xmlstructattr{passinfile} is used to indicate that the actual
  value should be saved into a file, and what is passed to the
  application is the file name instead of the actual text. 
  % 
  This should be used for safety, when there is a risk that the
  free-text can be harmful to the command-line (although the server
  does some checks to avoid this).
%
\end{itemize}
}
{}%r%

%% OPTION
\bigskip
\xmlstruct{option}
{%
Defines an option (i.e., a possible value) for a parameter.
}
{}%r%

%% Default value
\bigskip
\xmlstruct{defaultvalue}
{%
Defines a default value for a parameter.
}
{}%r%


%% \noindent
\xmlstructdef{textformat}

( \lst{"text"} | \lst{"html"} | \lst{"svg"})

\noindent
\xmlstructdef{paramvalue}

To Be Define

\noindent
\xmlstructdef{paramname}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{bool}

( \lst{"true"} | \lst{"false"} )

\noindent
\xmlstructdef{appid}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{widgetid}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{url}

A url

\noindent
\xmlstructdef{paramprefix}

Can be any string [a-z,A-Z,0-9,-,\_]+, usually it is \lst{"-"} or \lst{"--"}

\noindent
\xmlstructdef{text}

Any text


\noindent
\xmlstructdef{textformat}

( \lst{"text"} | \lst{"html"} | \lst{"svg"})

\noindent
\xmlstructdef{paramvalue}

To Be Define

\noindent
\xmlstructdef{paramname}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{int}

An integer value

\noindent
\xmlstructdef{bool}

( \lst{"true"} | \lst{"false"} )

\noindent
\xmlstructdef{appid}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{userid}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{widgetid}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{url}

A url

\noindent
\xmlstructdef{paramprefix}

Can be any string [a-z,A-Z,0-9,-,\_]+, usually it is \lst{"-"} or \lst{"--"}

\noindent
\xmlstructdef{path}

To be defined

\noindent
\xmlstructdef{githubbranch}

To be defined

\noindent
\xmlstructdef{githubuser}

To be defined

\noindent
\xmlstructdef{githubrepo}

To be defined

\noindent
\xmlstructdef{filename}

To be defined

\noindent
\xmlstructdef{foldername}

To be defined

\noindent
\xmlstructdef{cfgfilename}

To be defined

\noindent
\xmlstructdef{exsetid}

To be defined

\section{Communicating with \ei Server}
\label{ch:server:protocol}

At the moment we write an example with
 all the things that you can write.

\begin{lstlisting}
 var jsonParams = {
      "command": "execute",//command
      "app_id": "costa",//app id
      "parameters": {
          "lsa":["true"],//flag parameter
          "flag2":["false"], //flag parameter
          "sone":["sla"], //selectone parameter
          "smany":["slaa","tru"], //selectmany parameter
          "_ei_files": [
              {
                  "name": "prueba",
                  "type": "directory",
              },
              {
                  "name":"f1.txt",
                  "type": "file",
                  "content": "I'm f1.txt file\\n"
              },
              {
                  "name":"f2.txt",
                  "content": "I'm f2.txt file\\n"
              }
          ]//array of files and directories
      }//end parameters
  };// end jsonParams

   $\$$.post("eiserver.php",
    {
       eirequest: JSON.stringify(jsonParams)
    },
    function(data) { });
\end{lstlisting}

