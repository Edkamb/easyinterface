{% -*- mode: LaTeX; TeX-PDF-mode: t; TeX-master: "manual"; -*-
}
\chapter{\ei Server}
\label{ch:server}

This chapter describes the server side of the \ei framework, that we
refer to as the \ei server (or simply the server).
%
As explained in Section~\ref{ch:overview:arch:server}, the goal of
this server is to provide a uniform way to access local applications
and examples (i.e., those installed on the same machine where the
server runs).


The \ei server achieves the above goal by:
%
(1) providing a way to describe, using XML based configuration files,
how to execute a local application and which parameters it takes, as
well as define sets of related examples; and 
%
(2) providing a JSON based protocol that can be used to request
information on those applications and examples, execute applications,
etc.
%
Section~\ref{ch:server:config} describes the syntax of the server
configuration file, which covers point~(1) above; and
Section~\ref{ch:server:protocol} describes the protocol that can be
used to communicate with the server.
%
This chapter does not cover issues related to installation, for such
documentation see
\texttt{\href{http://github.com/abstools/easyinterface}{INSTALL.md}}.


\section{Configuring the \ei Server}
\label{ch:server:config}

This section describes how to configure the \ei server.
%
Section~\ref{ch:server:config:file} explains where the configuration
file show be placed, and Section~\ref{ch:server:config:xml} describes
the (valid) content of this file.
%
Before proceeding to the next sections, it highly recommended to read
Chapter~\ref{ch:quickguide} to get a general idea on how the
configuration file looks like, etc.


\subsection{Name and Path of the Configuration File}
\label{ch:server:config:file}

By default the server looks for the configuration file
\texttt{server/config/eiserver.cfg}, and if no such file exists it
uses \texttt{server/config/eiserver.default.cfg}.
%
The default installation comes with a predefined
\texttt{sever/config/eiserver.default.cfg} that includes some demo
applications and corresponding examples. It is very recommended not
make substantial changes to \texttt{eiserver.default.cfg}, and instead
create your own \texttt{eiserver.cfg}. This way you can always have a
correct configuration file at hand from which you can copy, etc.

\subsection{The Syntax of the Configuration File}

The content of the configuration file should adhere to the
$\xmlstructrefwb{eiserver}$ XML structure that is described
below. 
%
Inside this tag you can define applications, examples, etc. The best
way to understand how to do is follow the links in the defintion of
$\xmlstructrefwb{eiserver}$.

\subsubsection*{The main XML tag of the configuration file}

%% EISERVER
\bigskip
\xmlstruct
{eiserver}
{%
This XML tag is the root of the configurations file.
%
  The \xmlstructref{settings} section is used for setting some global
  parameters; the \xmlstructref{apps} section defines which
  applications are available on the server; and
  \xmlstructref{examples} defines which sets of examples are available
  on the server.
%
}
{}%r%

\subsubsection*{General settings}

%% SETTINGS
\bigskip
\xmlstruct
{settings}
{%
%
  This tag is does not include anything yet. It is reserved for future
  use, where we plan to put general settings that are related to the
  server and not to specific application or examples set.
%
}
{}%r%

\subsubsection*{Examples settings}

%% EXAMPLES
\bigskip
\xmlstruct
{examples}
{%
%
  The first form of this tag is used to declare sets of examples sets
  that are available in the server, where each such set is defined by
  one \xmlstructref{exset}.
%
  It is also possible to use the second form, where
  \xmlstructref{cfgfilename} is a file that contains an XML structure
  of the first form. Use the later form better organization of the
  different example sets.
%
}
{}%r%

%% EXSET
\bigskip
\xmlstruct
{exset}
{%
%
  The first form of this tag declare a set of examples, which are
  defined by collection of \xmlstructref{exelement} (a file, a
  directory, or a link to a github repository).
%
  The attribute \xmlstructattr{id} is a unique identifier that is used
  to refer to this set when communicating with the server.
%
  It is also possible to use the second form, where
  \xmlstructref{cfgfilename} is a file that contains an XML structure
  of the first form. However, in such case the \xmlstructattr{id} that
  appear in \xmlstructref{cfgfilename} is ignored.
%
}
{}%r%

%% EXAMPLE element
\bigskip
\xmlstruct
{exelement}
{%
%
  An example element, which can be a file $\xmlstructref{file}$, a
  folder $\xmlstructref{folder}$, or a link to a github repository
  $\xmlstructref{github}$.
%
}
{}%r%


%% File
\bigskip
\xmlstruct
{file}
{%
%
  This tags declares a file, where the \lst{name} attribute is its
  name and \lst{url} is a link to its content. Note that \lst{name} is
  not necessarily the same as the one in \lst{url}.
%
}
{}%r%

%% Folder
\bigskip
\xmlstruct
{folder}
{%
%
  This tags declares a folder with \lst{name} as its name. The content
  of this is a list of \xmlstructref{exelement} tags, which in turn
  declare the inner files, folders, etc.
%
}
{}%r%


%% GitHub
\bigskip
\xmlstruct
{github}
{%
%
  Declares a reference to the public github repository \lst{repo}
  which is owned by the user \lst{owner}. Optionally one can also
  refer to a specific \lst{branch} which \texttt{master} by default,
  and to a specific \lst{path} (a directory or a single file) which is
  a the root directory by default.
%
}
{}%r%

\subsubsection*{Applications settings}

%% APPS
\bigskip
\xmlstruct
{apps}
{
%
  Defines a list of \apps (to be available on the \ei server). Each
  \app is defined by an $\xmlstructrefwb{APP}$ XML structure.
%
}
{\xmlstructrefwb{eiserver}}

%% APP
\bigskip
\xmlstruct
{app}
{
%
  Defines an app, where the different parts are as follows:
%
  \begin{itemize}

  \item \xmlstructattr{id} is an identifier used when referring to the
    \app, it should be unique among the \apps available on the same
    server.

  \item \xmlstructattr{visible} indicates if the \app should be listed
    when the list of available \apps is requested, by default it is
    \xmlstructvalue{true}. Note that even if an app is not
    \emph{publicly} visible, it can be used like any other \app (you
    just need to know its identifier).

  \item \xmlstructref{appinfo} provides some general information about
    the \app, like title, logo, description, etc.

  \item \xmlstructref{apphelp} is a (formatted) text that provides
    enough information on how the \app can be used, etc. It will be
    mainly used in the help sections of the different clients.

  \item \xmlstructref{execinfo} defines how the tool can be executed
    (e.g., command-line, server). This information is used by the
    \apps server to forward execution requests to corresponding \apps.

  \item \xmlstructref{parameters} defines the parameters accepted by
    the \app. This parameters are usually passed to client, who will
    allow users to select the appropriate values, and when and
    execution request is sent to the \apps server, these options are
    passed to the corresponding \app.

  \item \xmlstructref{permission} defines some usage permissions for
    the \app, e.g., who have permission to execute this app. By
    default any one can execute.

  \end{itemize}
%
}
{\xmlstructrefwb{apps}}


%% APPINFO
\bigskip
\xmlstruct
{appinfo}
{
%
  Provides general information on an app:

  \begin{itemize}
  \item \xmlstructref{acronym} is an acronym for the app,
    e.g., COSTA;
  \item \xmlstructref{title} is a title for the app ;
  \item \xmlstructref{logo} is an image to be used as the
    app's logo; and
  \item \xmlstructref{desc} is a (general) description of the tool.
  \end{itemize}
%
}
{\xmlstructrefwb{app}}


%% ACRONYM
\bigskip
\xmlstruct
{acronym}
{
%
  Plain text to be used as an acronym, e.g., COSTA.
%
}
{\xmlstructrefwb{appinfo}}


%% TITLE
\bigskip
\xmlstruct
{title}
{
%
  Plain text deciding a title. Typically more informative than an acronym (see 
  $\xmlstructref{acronym}$.
%
}
{\xmlstructrefwb{appinfo}}


%% LOGO
\bigskip
\xmlstruct
{logo}
{
%
  A link to an image --- in some standard format such
  \xmlstructvalue{png}, \xmlstructvalue{jpg} or \xmlstructvalue{gif}
  --- to be used by clients as a logo (for an \app). The size of the
  image typically has equal height and width (but this is not a
  requirement).
%
}
{\xmlstructrefwb{appinfo}}


%% DESC
\bigskip
\xmlstruct
{desc}
{
%
  This is a description of some entities, e.g., of an \app, a
  parameter, a parameter option, etc. It consists of two parts, the
  first one is a short description, and the second is a detailed
  description. In both cases it should be plain text. Clients will
  select one of them depending on the intended use. The description is
  typically high-level.
%
}
{\xmlstructrefwb{appinfo}, \xmlstructrefwb{selectone}, \xmlstructrefwb{selectmany}}


%% APPHELP
\bigskip
\xmlstruct
{apphelp}
{
%
  A (formatted) text that provides enough information on how an \app
  can be used, etc. It can be provided in several formats, e.g., html
  or plain text, by using several \xmlstructref{content} tags. Client
  are supposed to pick the appropriate format. It is recommended to
  always include a content in plain text since it can be view in any
  client.
%
}
{\xmlstructrefwb{app}}


%% CONTENT
\bigskip
\xmlstruct
{content}
{
%
  A text given in a specific \xmlstructattr{format}, e.g.,
  \xmlstructvalue{"text"}, \xmlstructvalue{"html"}, etc. If the
  attribute \xmlstructattr{format} is not provided, then it is assumed
  to be \xmlstructvalue{"text"} format (plain text).
%
}
{\xmlstructrefwb{apphelp}, \xmlstructrefwb{eicommand}}

%% EXECINFO
\bigskip
\xmlstruct{execinfo}
{
%
  Provides information on how to execute an app. It can be
  either a command-line app \xmlstructref{cmdlineapp}, or a
  server based app \xmlstructref{serverapp}. 
%
}
{\xmlstructrefwb{app}}

%% CMDLINEAPP
\noindent
\xmlstruct{cmdlineapp}
{
%
  Describes how to run a command-line \app, where
  \xmlstructdef{command\_template} is a template describing a
  command-line. It is best explained by an example. Consider the
  following template example

  \bigskip
  ~~~
  \fbox{\small\texttt{/path-to/app \xmlstructtemplate{_ei_files} -m \xmlstructtemplate{_ei_outline}  \xmlstructtemplate{_ei_parametes}}}
  
  \bigskip
  \noindent
  In this template, anything that starts with \xmlstructtemplate{_ei}
  is a template parameter that will be replaced by some corresponding
  information, and \texttt{/path-to/app} is the \app's executable.
  % 
  When the server receives a request for executing the corresponding
  \app, the request includes several data that should passed to the
  \app. For example, the following are typical data that should be
  passed to an \app is:
  %
  \begin{enumerate}
  \item files to be processed (e.g., program to be analysed);
  \item entities selected from the program outline (e.g., methods); and
  \item values for the different parameters.
  \end{enumerate}
  %
  The server passes this data to the \app by replacing the template
  parameters with corresponding data as follows:
  % 
  \begin{enumerate}
  \item the files are stored locally (e.g., in \texttt{/tmp}), and
    \xmlstructtemplate{_ei_files} is replaced by a list file names
    (each with an absolute path, separated by a space);
  \item \xmlstructtemplate{_ei_outline} is replaced by a list of
    selected entities (e.g., method names) --- see TODO; and
  \item \xmlstructtemplate{_ei_parametes} is replaced by the list of
    parameters generated from those provided in the request (see TODO).
  \end{enumerate}
  % 
  This result in, for example, the following instance of the template:

  \bigskip
  \hspace{0.7cm}
  \fbox{\texttt{/path-to/app \xmlstructtemplate{a.java b.java} -m \xmlstructtemplate{a.main} \xmlstructtemplate{-v 1 -d 3 -a}}}

  \bigskip 
  \noindent
  which is then executed and its output is redirected to the
  client. The server does some security checks to guarantee that the
  command-line is not executed in a bad way (see Section~\ref{})

  \bigskip 
  \noindent
  The following is a list of template parameters:

%%
  \begin{itemize}
  \item \xmlstructtemplate{_ei_files} which is replaced by a list of
    file names (separated by space) in the local file system;
\item \xmlstructtemplate{_ei_dirs} which is replaced by a list of
  dirs in the local file system;
\item \xmlstructtemplate{_ei_root} which is replaced by the local
  temporary directory name, where all files have been saved;
%%
  \item \xmlstructtemplate{_ei_outline} which is replaced by a list of
    selected entities (separated by space);
%%
  \item \xmlstructtemplate{_ei_parametes} which is replace by a
    corresponding list of parameters --- see Section~\ref{} for
    information on how this list is constructed;
%%
  \item \xmlstructtemplate{_ei_sessionid} which is replaced by a
    session identifier, this makes it possible to track the information
    of a user along several request (see Section~\ref{})
%%
  \item \xmlstructtemplate{_ei_clientid} which is replaced by a the
    client identifier, i.e., web-interface, eclipse, etc, which makes
    it possible to provide output depending on the client (not
    recommended since it double the amount of work). See
    Section~\ref{} for a list of clients.
  \end{itemize}
%%
%%   % 
}
{\xmlstructrefwb{execinfo}}

%% SERTVERAPP
\bigskip
\xmlstruct
{serverapp}
{
%
  Defines a server based application that is available at the address
  specified by the attribute \xmlstructattr{url}. In this kind of apps
  the \apps server passes the request, as it is, to the app --- See
  Section~\ref{} for more information.
%
}
{\xmlstructrefwb{execinfo}}

%% PARAMETERS
\bigskip 
\xmlstruct
{parameters} 
{
%
  Defines a list of parameters that are accepted by a corresponding
  tool. In the \xmlstructattr{prefix} attribute you can specify a
  string that will be attached to each parameter name when passed to
  the app (only in command-line mode, see
  \xmlstructrefwb{cmdlineapp}).
  % 
  For example, if \xmlstructattr{prefix}=\xmlstructvalue{"{-}{-}"} and
  we have a parameter called 'level' with value X, then '{-}{-}level
  X' will be passed to the app. The default value of
  \xmlstructattr{prefix} is \xmlstructvalue{"-"}. You can set
  \xmlstructattr{prefix} to the empty string \xmlstructvalue{""} if
  there is no need to attach anything to the option name, in such case
  the parameter name will probably include this prefix as part of its
  name.Also, you can indicate in the \xmlstructattr{check} attribute
  if you want or not that the parameters be check with your
  specification. The default value of \xmlstructattr{check} is
  \xmlstructvalue{"true"}. \xmlstructattr{check} value is like the
  \xmlstructattr{prefix} value, it is inherit on all parameters, but
  you can change on each one this properties.
%
}
{\xmlstructrefwb{appinfo}}

%% PARAM
\bigskip
\xmlstruct{param}
{
%
  Defines a parameter accepted by a corresponding app. There are
  several types of paramaters supported
%
}
{\xmlstructrefwb{parameters}}

%% SELECTONE
\bigskip
\xmlstruct
{selectone}
{
%
  Defines a parameter that takes a \emph{single} value out of a given
  list:

  \begin{itemize}
  \item \xmlstructattr{name} is the name of the parameter, it must be
    unique among all parameters of an app;

  \item \xmlstructref{desc} describes the meaning of the parameter;

  \item \xmlstructref{paramvalue}+ is a list of possible values for
    this parameter;

  \item \xmlstructref{defaultvalue} specifies the default
    value. If not specified then the first \xmlstructref{paramvalue}
    is considered as the default one;

  \item \xmlstructattr{widgetid} specifies the preferred layout when
    used in a client with a graphical interface (e.g., combo-box,
    radio button, etc.). See \xmlstructref{widgetid} for a list of
    widgets for this kind of parameter.
\item \xmlstructattr{prefix} and \xmlstructattr{check} can override the default value of these attributes, specified in \xmlstructref{parameters}, for this particular parameter.
  \end{itemize}
  %
 } {\xmlstructrefwb{param}}

%% SELECTMANY
\bigskip
\xmlstruct{selectmany}
{
%
  Defines a parameter that takes \emph{several} values out of a given
  list:

  \begin{itemize}
  \item \xmlstructattr{name} is the name of the parameter, it must be
    unique among all parameters of an app;

  \item \xmlstructref{desc} describes the meaning of the parameter;

  \item \xmlstructref{paramvalue}+ is a list of possible values for
    this parameter;

  \item \xmlstructref{defaultvalue} specifies the default
    value. If not specified then the first \xmlstructref{paramvalue}
    is considered as the default one;

  \item \xmlstructattr{widgetid} specifies the preferred layout when
    used in a client with a graphical interface (e.g., combo-box,
    radio button, etc.). See \xmlstructref{widgetid} for a list of
    widgets for this kind of parameter.
\item \xmlstructattr{prefix} and \xmlstructattr{check} can override the default value of these attributes, specified in \xmlstructref{parameters}, for this particular parameter.
  \end{itemize}
  % 
 } {\xmlstructrefwb{param}}

%% FLAG
\bigskip
\xmlstruct{flag}
{In this case the default should specify just \emph{true} or
  \emph{false}. This is ONLY to say if one parameter appears or not.
  \begin{itemize}
  \item \xmlstructattr{name} is the name of the parameter, it must be
    unique among all parameters of an app;

  \item \xmlstructref{desc} describes the meaning of the parameter;

  \item \xmlstructref{defaultvalue} specifies the default
    value. If not specified then the \emph{false} value is considered as the default one;

  \item \xmlstructattr{widgetid} specifies the preferred layout when
    used in a client with a graphical interface (e.g., combo-box,
    radio button, etc.). See \xmlstructref{widgetid} for a list of
    widgets for this kind of parameter.
\item \xmlstructattr{prefix} and \xmlstructattr{check} can override the default value of these attributes, specified in \xmlstructref{parameters}, for this particular parameter.
  \end{itemize}
}
{\xmlstructrefwb{param}}

%% TEXTFIELD
\bigskip
\xmlstruct{textfield}
{In this case the parameter is some text,this text will be passed to the app as a string or file depending on the flag \xmlstructattr{method}

\begin{itemize}
  \item \xmlstructattr{name} is the name of the parameter, it must be
    unique among all parameters of an app;

  \item \xmlstructref{desc} describes the meaning of the parameter;

  \item \xmlstructref{defaultvalue} specifies the default
    value.

  \item \xmlstructattr{widgetid} specifies the preferred layout when
    used in a client with a graphical interface (e.g., combo-box,
    radio button, etc.). See \xmlstructref{widgetid} for a list of
    widgets for this kind of parameter.
\item \xmlstructattr{prefix} and \xmlstructattr{check} can override the default value of these attributes, specified in \xmlstructref{parameters}, for this particular parameter.
  \end{itemize}
}{\xmlstructrefwb{param}}

%% HIDDEN
\bigskip
\xmlstruct{hidden}
{In this case the parameter is not showed in the app but the value is
  used like an other parameter.

\begin{itemize}
  \item \xmlstructattr{name} is the name of the parameter, it must be
    unique among all parameters of an app;

  \item \xmlstructattr{value} specifies the value.

\item \xmlstructattr{prefix} can override the default value of this attribute, specified in \xmlstructref{parameters}, for this particular parameter.
  \end{itemize}}
{\xmlstructrefwb{param}}

%% PERMISSION
\bigskip
\xmlstruct{permission}
{This is a list of users that are allowed or excluded to execute an
  app. \xmlstructattr{default} is the default value to all user that
  doesnt appear on this list. If an user appear in both list, the list
of excluded is the most important.}
{\xmlstructrefwb{app}}

%% ALLOWED
\bigskip
\xmlstruct{allowed}
{This is a list of users thar are allowed to use an app.}
{\xmlstructrefwb{permission}}

%% EXCLUDE
\bigskip
\xmlstruct{excluded}
{This is a list of users thar are excluded to use an app.}
{\xmlstructrefwb{permission}}

%% USER
\bigskip
\xmlstruct{user}
{It have an \xmlstructattr{id} of an user.}
{\xmlstructrefwb{allowed}, \xmlstructrefwb{excluded}}

\noindent
\xmlstructdef{option}


\begin{lstlisting}
<option value=$\xmlstructref{paramvalue}$>$\xmlstructref{desc}$</option>
\end{lstlisting}

\noindent
\xmlstructdef{defaultvalue}

\begin{lstlisting}
<default value=$\xmlstructref{paramvalue}$ />
\end{lstlisting}
or
\begin{lstlisting}
<default>$\xmlstructref{paramvalue}$ </default>
\end{lstlisting}

\noindent
\xmlstructdef{textformat}

( \lst{"text"} | \lst{"html"} | \lst{"svg"})

\noindent
\xmlstructdef{paramvalue}

To Be Define

\noindent
\xmlstructdef{paramname}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{int}

An integer value

\noindent
\xmlstructdef{bool}

( \lst{"true"} | \lst{"false"} )

\noindent
\xmlstructdef{appid}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{userid}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{widgetid}

[a-z,A-Z,0-9,-,\_]+

\noindent
\xmlstructdef{url}

A url

\noindent
\xmlstructdef{exurl}

A url

\noindent
\xmlstructdef{paramprefix}

Can be any string [a-z,A-Z,0-9,-,\_]+, usually it is \lst{"-"} or \lst{"--"}

\noindent
\xmlstructdef{text}

Any text

\bigskip
\bigskip
\section{Communicating with \ei Server}

At the moment we write an example with
 all the things that you can write.

\begin{lstlisting}
 var jsonParams = {
      "command": "execute",//command
      "app_id": "costa",//app id
      "parameters": {
          "lsa":["true"],//flag parameter
          "flag2":["false"], //flag parameter
          "sone":["sla"], //selectone parameter
          "smany":["slaa","tru"], //selectmany parameter
          "_ei_files": [
              {
                  "name": "prueba",
                  "type": "directory",
              },
              {
                  "name":"f1.txt",
                  "type": "file",
                  "content": "I'm f1.txt file\\n"
              },
              {
                  "name":"f2.txt",
                  "content": "I'm f2.txt file\\n"
              }
          ]//array of files and directories
      }//end parameters
  };// end jsonParams

   $\$$.post("eiserver.php",
    {
       eirequest: JSON.stringify(jsonParams)
    },
    function(data) { });
\end{lstlisting}

